const app = {\n    data: [],\n    config: {\n        owner: '',\n        repo: '',\n        token: '',\n        path: 'data/projects.json'\n    },\n    sha: null,\n    editorModal: null,\n    settingsModal: null,\n    MAX_JIRA_LINKS: 10,\n    MAX_CUSTOM_MILESTONES: 5,\n\n    MILESTONES: [\n        { key: 'dataIA',            label: 'ü§ñ Consegna IA',           badge: 'bg-info text-dark' },\n        { key: 'devStart',          label: '‚ñ∂Ô∏è Inizio Sviluppo',        badge: 'bg-primary' },\n        { key: 'devEnd',            label: '‚èπÔ∏è Fine Sviluppo',          badge: 'bg-secondary' },\n        { key: 'dataUAT',           label: 'üë• UAT',                    badge: 'bg-info' },\n        { key: 'dataBS',            label: 'üíº Business Simulation',    badge: 'bg-dark' },\n        { key: 'dataTest',          label: 'üß™ Rilascio Test',          badge: 'bg-warning text-dark' },\n        { key: 'dataProd',          label: 'üöÄ Rilascio Prod',          badge: 'bg-success' },\n        { key: 'dataScadenzaStima', label: 'üì• Scad. Stima Fornitore', badge: 'bg-light text-dark border' },\n        { key: 'dataConfigSistema', label: 'üîß Config Sistema',         badge: 'bg-light text-dark border' }\n    ],\n\n    // Mappa colori manuale per owner specifici (chiavi in lowercase)\n    OWNER_COLORS: {\n        'simone': { bg: '#0d6efd', fg: '#ffffff' }, // blu\n        'flavia': { bg: '#6f42c1', fg: '#ffffff' }, // viola\n        'andrea': { bg: '#ffc107', fg: '#212529' }, // giallo\n    },\n\n    init: function() {\n        this.editorModal = new bootstrap.Modal(document.getElementById('editorModal'));\n        this.settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));\n\n        ['p_stimaGgu', 'p_rcFornitore'].forEach(id => {\n            const el = document.getElementById(id);\n            if (el) el.addEventListener('input', () => this.calcCosto());\n        });\n\n        const savedCfg = localStorage.getItem('pm_tracker_config');\n        if (savedCfg) {\n            this.config = JSON.parse(savedCfg);\n            this.loadData();\n        } else {\n            this.showSettings();\n        }\n    },\n\n    csvToArray: function(val) {\n        if (!val) return [];\n        if (Array.isArray(val)) return val.map(s => (s || '').toString().trim()).filter(Boolean);\n        if (typeof val === 'string') return val.split(',').map(s => s.trim()).filter(Boolean);\n        return [];\n    },\n\n    normalizeProject: function(p) {\n        const owners    = this.csvToArray(p.owners || p.owner);\n        const fornitori = this.csvToArray(p.fornitori);\n        const customMilestones = Array.isArray(p.customMilestones) ? p.customMilestones : [];\n        const hidden = !!p.hidden;\n        return { ...p, owners, fornitori, customMilestones, hidden };\n    },\n\n    // Restituisce true se il progetto ha dataProd ed √® passata da pi√π di 1 mese\n    isAutoStale: function(p) {\n        if (p.hidden) return false; // Se √® gi√† archiviato manualmente, non serve\n        if (!p.dataProd) return false;\n        \n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n        \n        const prodDate = new Date(p.dataProd);\n        const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());\n        \n        return prodDate < oneMonthAgo;\n    },\n\n    // Determina se il progetto deve essere nascosto per l'UI (sia se manuale che automatico)\n    isHiddenForUI: function(p) {\n        return p.hidden || this.isAutoStale(p);\n    },\n\n    // --- UTILITY COLORI BADGE ---\n    _hashString: function(str) {\n        const s = (str || '').toString().trim().toLowerCase();\n        let h = 0;\n        for (let i = 0; i < s.length; i++) h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;\n        return Math.abs(h);\n    },\n\n    _autoColor: function(name, kind) {\n        const hue = this._hashString(`${kind}:${name}`) % 360;\n        return { bg: `hsl(${hue}, 65%, 45%)`, fg: '#ffffff' };\n    },\n\n    _badgeColor: function(kind, name) {\n        const key = (name || '').toString().trim().toLowerCase();\n        if (kind === 'owner' && this.OWNER_COLORS[key]) {\n            return this.OWNER_COLORS[key];\n        }\n        return this._autoColor(name, kind);\n    },\n\n    _badgeStyle: function(kind, name) {\n        const c = this._badgeColor(kind, name);\n        return `background: ${c.bg} !important; color: ${c.fg} !important; border: 1px solid rgba(0,0,0,0.12);`;\n    },\n\n    _badgeSpan: function(kind, name, className) {\n        const safeName = (name ?? '').toString();\n        return `<span class=\"${className}\" style=\"${this._badgeStyle(kind, safeName)}\">${safeName}</span>`;\n    },\n    // ----------------------------\n\n    // --- GESTIONE CUSTOM MILESTONES ---\n    renderCustomMilestoneFields: function(milestones) {\n        const container = document.getElementById('customMilestonesContainer');\n        container.innerHTML = '';\n        const items = (milestones && milestones.length > 0) ? milestones : [];\n        items.forEach((m, i) => this._appendCustomMilestoneField(m.label, m.date, i));\n        this._updateAddCustomMilestoneBtn();\n    },\n\n    _appendCustomMilestoneField: function(label, date, index) {\n        const container = document.getElementById('customMilestonesContainer');\n        const wrap = document.createElement('div');\n        wrap.className = 'd-flex align-items-center gap-2 mb-2 custom-milestone-row';\n        wrap.dataset.milestoneIndex = index;\n        wrap.innerHTML = `\n            <input type=\"text\" class=\"form-control form-control-sm custom-ms-label\" placeholder=\"Nome (es: Creare Story)\" value=\"${label ? label.replace(/\"/g, '&quot;') : ''}\">\n            <input type=\"date\" class=\"form-control form-control-sm custom-ms-date\" value=\"${date || ''}\">\n            <button type=\"button\" class=\"btn btn-outline-danger btn-sm flex-shrink-0\" onclick=\"app.removeCustomMilestone(this)\" title=\"Rimuovi\">&times;</button>\n        `;\n        container.appendChild(wrap);\n    },\n\n    addCustomMilestone: function() {\n        const container = document.getElementById('customMilestonesContainer');\n        const count = container.querySelectorAll('.custom-milestone-row').length;\n        if (count >= this.MAX_CUSTOM_MILESTONES) return;\n        this._appendCustomMilestoneField('', '', count);\n        this._updateAddCustomMilestoneBtn();\n    },\n\n    removeCustomMilestone: function(btn) {\n        btn.closest('.custom-milestone-row').remove();\n        this._updateAddCustomMilestoneBtn();\n    },\n\n    _updateAddCustomMilestoneBtn: function() {\n        const container = document.getElementById('customMilestonesContainer');\n        const btn = document.querySelector('button[onclick=\"app.addCustomMilestone()\"]');\n        if (!btn) return;\n        const count = container.querySelectorAll('.custom-milestone-row').length;\n        btn.disabled = count >= this.MAX_CUSTOM_MILESTONES;\n        btn.textContent = count >= this.MAX_CUSTOM_MILESTONES\n            ? `Limite raggiunto (${this.MAX_CUSTOM_MILESTONES})`\n            : '+ Aggiungi Milestone Personalizzata';\n    },\n\n    _getCustomMilestonesFromModal: function() {\n        const rows = Array.from(document.querySelectorAll('.custom-milestone-row'));\n        return rows.map(row => {\n            return {\n                label: row.querySelector('.custom-ms-label').value.trim(),\n                date: row.querySelector('.custom-ms-date').value\n            };\n        }).filter(m => m.label !== '' && m.date !== '');\n    },\n    // ----------------------------------\n\n    jiraLabel: function(url) {\n        if (!url || !url.trim()) return '';\n        try {\n            const u = new URL(url.trim());\n            const parts = u.pathname.replace(/\\/$/, '').split('/');\n            return parts[parts.length - 1] || url;\n        } catch (e) {\n            const parts = url.trim().replace(/\\/$/, '').split('/');\n            return parts[parts.length - 1] || url;\n        }\n    },\n\n    jiraLinksHtml: function(jiraLinks) {\n        if (!jiraLinks || jiraLinks.length === 0) return '';\n        return jiraLinks\n            .filter(u => u && u.trim())\n            .map(u => `<a href=\"${u}\" target=\"_blank\" class=\"badge bg-primary text-decoration-none me-1 mb-1\" title=\"${u}\">${this.jiraLabel(u)} üîó</a>`)\n            .join('');\n    },\n\n    renderJiraFields: function(links) {\n        const container = document.getElementById('jiraLinksContainer');\n        container.innerHTML = '';\n        const items = (links && links.length > 0) ? links : [''];\n        items.forEach((url, i) => this._appendJiraField(url, i));\n        this._updateAddJiraBtn();\n    },\n\n    _appendJiraField: function(value, index) {\n        const container = document.getElementById('jiraLinksContainer');\n        const wrap = document.createElement('div');\n        wrap.className = 'd-flex align-items-center gap-2 mb-2';\n        wrap.dataset.jiraIndex = index;\n        wrap.innerHTML = `\n            <input type=\"url\" class=\"form-control jira-link-input\" placeholder=\"https://...\" value=\"${value ? value.replace(/\"/g, '&quot;') : ''}\">\n            <button type=\"button\" class=\"btn btn-outline-danger btn-sm flex-shrink-0\" onclick=\"app.removeJiraField(this)\" title=\"Rimuovi\">&times;</button>\n        `;\n        container.appendChild(wrap);\n    },\n\n    addJiraField: function() {\n        const container = document.getElementById('jiraLinksContainer');\n        const count = container.querySelectorAll('.jira-link-input').length;\n        if (count >= this.MAX_JIRA_LINKS) return;\n        this._appendJiraField('', count);\n        this._updateAddJiraBtn();\n    },\n\n    removeJiraField: function(btn) {\n        btn.closest('[data-jira-index]').remove();\n        this._updateAddJiraBtn();\n    },\n\n    _updateAddJiraBtn: function() {\n        const container = document.getElementById('jiraLinksContainer');\n        const btn = document.getElementById('addJiraBtn');\n        if (!btn) return;\n        const count = container.querySelectorAll('.jira-link-input').length;\n        btn.disabled = count >= this.MAX_JIRA_LINKS;\n        btn.textContent = count >= this.MAX_JIRA_LINKS\n            ? `Limite raggiunto (${this.MAX_JIRA_LINKS})`\n            : '+ Aggiungi Link Jira';\n    },\n\n    _getJiraLinksFromModal: function() {\n        return Array.from(document.querySelectorAll('.jira-link-input'))\n            .map(el => el.value.trim())\n            .filter(v => v !== '');\n    },\n\n    calcCosto: function() {\n        const ggu = parseFloat(document.getElementById('p_stimaGgu').value);\n        const rc  = parseFloat(document.getElementById('p_rcFornitore').value);\n        const out = document.getElementById('p_stimaCosto');\n        if (!isNaN(ggu) && !isNaN(rc) && ggu >= 0 && rc >= 0) {\n            out.value = '‚Ç¨ ' + (ggu * rc).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n        } else {\n            out.value = '';\n        }\n    },\n\n    showSettings: function() {\n        document.getElementById('cfg_owner').value = this.config.owner;\n        document.getElementById('cfg_repo').value  = this.config.repo;\n        document.getElementById('cfg_token').value = this.config.token;\n        document.getElementById('cfg_path').value  = this.config.path;\n        this.settingsModal.show();\n    },\n\n    saveSettings: function() {\n        this.config = {\n            owner: document.getElementById('cfg_owner').value.trim(),\n            repo:  document.getElementById('cfg_repo').value.trim(),\n            token: document.getElementById('cfg_token').value.trim(),\n            path:  document.getElementById('cfg_path').value.trim() || 'data/projects.json'\n        };\n        localStorage.setItem('pm_tracker_config', JSON.stringify(this.config));\n        this.settingsModal.hide();\n        this.loadData();\n    },\n\n    loadData: async function() {\n        if (!this.config.token) return;\n        this.showAlert('Caricamento dati...', 'info');\n        try {\n            const url = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/contents/${this.config.path}?t=${new Date().getTime()}`;\n            const response = await fetch(url, {\n                headers: {\n                    'Authorization': `token ${this.config.token}`,\n                    'Accept': 'application/vnd.github.v3+json'\n                }\n            });\n            if (!response.ok) throw new Error(`Errore GitHub: ${response.status}`);\n            const json = await response.json();\n            this.sha  = json.sha;\n            this.data = JSON.parse(decodeURIComponent(escape(atob(json.content)))).map(p => this.normalizeProject(p));\n            this.populateFornitoreFilters();\n            this.populateOwnerFilters();\n            this.renderAll();\n            this.showAlert('Dati aggiornati con successo!', 'success', 2000);\n        } catch (error) {\n            console.error(error);\n            this.showAlert(`Impossibile caricare i dati: ${error.message}`, 'danger');\n        }\n    },\n\n    populateFornitoreFilters: function() {\n        const allSuppliers = [...new Set(this.data.flatMap(p => p.fornitori || []))].sort();\n        ['ganttFornitoreFilter', 'tableFornitoreFilter', 'calendarFornitoreFilter'].forEach(id => {\n            const sel = document.getElementById(id);\n            if (!sel) return;\n            const current = sel.value;\n            while (sel.options.length > 1) sel.remove(1);\n            allSuppliers.forEach(f => {\n                const opt = document.createElement('option');\n                opt.value = f;\n                opt.textContent = f;\n                sel.appendChild(opt);\n            });\n            if (current && allSuppliers.includes(current)) sel.value = current;\n        });\n    },\n\n    populateOwnerFilters: function() {\n        const allOwners = [...new Set(this.data.flatMap(p => p.owners || []))].sort((a, b) => a.localeCompare(b, 'it'));\n        ['ganttOwnerFilter', 'tableOwnerFilter', 'calendarOwnerFilter'].forEach(id => {\n            const sel = document.getElementById(id);\n            if (!sel) return;\n            const current = sel.value;\n            while (sel.options.length > 1) sel.remove(1);\n            allOwners.forEach(o => {\n                const opt = document.createElement('option');\n                opt.value = o;\n                opt.textContent = o;\n                sel.appendChild(opt);\n            });\n            if (current && allOwners.includes(current)) sel.value = current;\n        });\n    },\n\n    saveProject: async function() {\n        const dates = {\n            stima:    document.getElementById('p_stima').value || null,\n            ia:       document.getElementById('p_ia').value || null,\n            devStart: document.getElementById('p_devStart').value || null,\n            devEnd:   document.getElementById('p_devEnd').value || null,\n            test:     document.getElementById('p_test').value || null,\n            prod:     document.getElementById('p_prod').value || null,\n            uat:      document.getElementById('p_uat').value || null,\n            bs:       document.getElementById('p_bs').value || null\n        };\n\n        // Check sequence solo se ENTRAMBE le date della coppia esistono\n        let errorMsg = '';\n        if (dates.stima && dates.devStart && dates.stima > dates.devStart) errorMsg = 'Stima non pu√≤ essere successiva a Dev Start';\n        else if (dates.devStart && dates.devEnd && dates.devStart > dates.devEnd) errorMsg = 'Dev Start non pu√≤ essere successivo a Dev End';\n        else if (dates.devEnd && dates.test && dates.devEnd > dates.test) errorMsg = 'Dev End non pu√≤ essere successivo al Test';\n        else if (dates.test && dates.prod && dates.test > dates.prod) errorMsg = 'Il Test non pu√≤ essere successivo a Prod';\n        \n        if (errorMsg) {\n            document.getElementById('dateValidationMsg').innerText = `ERRORE: ${errorMsg}`;\n            return;\n        }\n\n        const stimaGgu    = parseFloat(document.getElementById('p_stimaGgu').value);\n        const rcFornitore = parseFloat(document.getElementById('p_rcFornitore').value);\n        const id = document.getElementById('p_id').value;\n\n        const fornitori = document.getElementById('p_fornitori').value.split(',').map(s => s.trim()).filter(Boolean);\n        const owners    = document.getElementById('p_owners').value.split(',').map(s => s.trim()).filter(Boolean);\n\n        const newProj = {\n            id:                id || Date.now().toString(),\n            nome:              document.getElementById('p_nome').value,\n            fornitori:         fornitori,\n            owners:            owners,\n            dataStima:         dates.stima,\n            dataIA:            dates.ia,\n            devStart:          dates.devStart,\n            devEnd:            dates.devEnd,\n            dataTest:          dates.test,\n            dataProd:          dates.prod,\n            dataUAT:           dates.uat,\n            dataBS:            dates.bs,\n            jiraLinks:         this._getJiraLinksFromModal(),\n            customMilestones:  this._getCustomMilestonesFromModal(),\n            dataScadenzaStima: document.getElementById('p_dataScadenzaStima').value || null,\n            dataConfigSistema: document.getElementById('p_dataConfigSistema').value || null,\n            stimaGgu:          isNaN(stimaGgu)    ? null : stimaGgu,\n            rcFornitore:       isNaN(rcFornitore) ? null : rcFornitore,\n            stimaCosto:        (!isNaN(stimaGgu) && !isNaN(rcFornitore)) ? stimaGgu * rcFornitore : null,\n            note:              document.getElementById('p_note').value,\n            hidden:            false // default quando creato nuovo, o sovrascritto se stiamo aggiornando\n        };\n\n        if (id) {\n            const oldProj = this.data.find(p => p.id === id);\n            if (oldProj && oldProj.hidden) newProj.hidden = true;\n            this.data[this.data.findIndex(p => p.id === id)] = newProj;\n        } else {\n            this.data.push(newProj);\n        }\n        await this.syncToGithub();\n        this.editorModal.hide();\n    },\n\n    syncToGithub: async function() {\n        this.showAlert('Salvataggio su GitHub in corso...', 'warning');\n        try {\n            const content = btoa(unescape(encodeURIComponent(JSON.stringify(this.data, null, 2))));\n            const url = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/contents/${this.config.path}`;\n            const response = await fetch(url, {\n                method: 'PUT',\n                headers: { 'Authorization': `token ${this.config.token}`, 'Content-Type': 'application/json' },\n                body: JSON.stringify({ message: `Update data via PM Tracker webapp - ${new Date().toISOString()}`, content, sha: this.sha })\n            });\n            if (!response.ok) {\n                const err = await response.json();\n                throw new Error(err.message || 'Salvataggio fallito');\n            }\n            this.sha = (await response.json()).content.sha;\n            this.showAlert('Dati salvati su GitHub! Aggiornamento in corso...', 'success');\n            await this.loadData();\n        } catch (e) {\n            console.error('Errore sync:', e);\n            this.showAlert(`Errore salvataggio: ${e.message}`, 'danger');\n        }\n    },\n\n    openModal: function(id = null) {\n        document.getElementById('projectForm').reset();\n        document.getElementById('dateValidationMsg').innerText = '';\n        document.getElementById('p_stimaCosto').value = '';\n        if (id) {\n            const p = this.data.find(x => x.id === id);\n            document.getElementById('p_id').value                = p.id;\n            document.getElementById('p_nome').value              = p.nome;\n            document.getElementById('p_fornitori').value         = (p.fornitori || []).join(', ');\n            document.getElementById('p_owners').value            = this.csvToArray(p.owners || p.owner).join(', ');\n            document.getElementById('p_stima').value             = p.dataStima    || '';\n            document.getElementById('p_ia').value                = p.dataIA       || '';\n            document.getElementById('p_devStart').value          = p.devStart     || '';\n            document.getElementById('p_devEnd').value            = p.devEnd       || '';\n            document.getElementById('p_test').value              = p.dataTest     || '';\n            document.getElementById('p_prod').value              = p.dataProd     || '';\n            document.getElementById('p_uat').value               = p.dataUAT      || '';\n            document.getElementById('p_bs').value                = p.dataBS       || '';\n            document.getElementById('p_dataScadenzaStima').value = p.dataScadenzaStima || '';\n            document.getElementById('p_dataConfigSistema').value = p.dataConfigSistema || '';\n            document.getElementById('p_stimaGgu').value          = p.stimaGgu    != null ? p.stimaGgu    : '';\n            document.getElementById('p_rcFornitore').value       = p.rcFornitore != null ? p.rcFornitore : '';\n            document.getElementById('p_note').value              = p.note || '';\n            this.calcCosto();\n            \n            const links = p.jiraLinks && p.jiraLinks.length > 0 ? p.jiraLinks : (p.jira ? [p.jira] : []);\n            this.renderJiraFields(links);\n            this.renderCustomMilestoneFields(p.customMilestones || []);\n        } else {\n            document.getElementById('p_id').value = '';\n            this.renderJiraFields([]);\n            this.renderCustomMilestoneFields([]);\n        }\n        this.editorModal.show();\n    },\n\n    deleteProject: async function(id) {\n        if (confirm('Sei sicuro di voler eliminare questo progetto?')) {\n            this.data = this.data.filter(p => p.id !== id);\n            await this.syncToGithub();\n        }\n    },\n\n    toggleHidden: async function(id) {\n        const p = this.data.find(x => x.id === id);\n        if (p) {\n            // Se era nascosto solo in automatico, ma l'utente clicca su nascondi/ripristina\n            // Sovrascriviamo l'azione forzando hidden su true o false\n            if (this.isAutoStale(p) && !p.hidden) {\n                p.hidden = false; // Permettiamo di \"dis-archiviare\" temporaneamente (se gestibile)\n            } else {\n                p.hidden = !p.hidden;\n            }\n            \n            // Se dopo il toggle isHiddenForUI √® ancora vero, mostriamo un alert perch√© l'azione\n            // potrebbe sembrare non avere effetto\n            if (!p.hidden && this.isAutoStale(p)) {\n                this.showAlert('Progetto ripristinato, ma √® vecchio di 1 mese. Lo vedrai ancora archiviato automaticamente. Rimuovi la data di Prod o cambiala per ripristinarlo.', 'warning', 5000);\n                p.hidden = false;\n            }\n            await this.syncToGithub();\n        }\n    },\n\n    _sortGantt: function(data, mode) {\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n        const d = (val) => val ? new Date(val) : new Date(0);\n        const inProgress = (p) => {\n            const prod = p.dataProd ? new Date(p.dataProd) : null;\n            return !prod || prod > today;\n        };\n        const sorted = [...data];\n        switch (mode) {\n            case 'prod_inprogress_first':\n                sorted.sort((a, b) => {\n                    const ia = inProgress(a) ? 0 : 1;\n                    const ib = inProgress(b) ? 0 : 1;\n                    if (ia !== ib) return ia - ib;\n                    return d(a.dataProd) - d(b.dataProd);\n                });\n                break;\n            case 'prod_asc':\n                sorted.sort((a, b) => d(a.dataProd) - d(b.dataProd));\n                break;\n            case 'prod_desc':\n                sorted.sort((a, b) => d(b.dataProd) - d(a.dataProd));\n                break;\n            case 'devStart_inprogress_first':\n                sorted.sort((a, b) => {\n                    const ia = inProgress(a) ? 0 : 1;\n                    const ib = inProgress(b) ? 0 : 1;\n                    if (ia !== ib) return ia - ib;\n                    return d(a.devStart) - d(b.devStart);\n                });\n                break;\n            case 'devStart_asc':\n                sorted.sort((a, b) => d(a.devStart) - d(b.devStart));\n                break;\n            case 'devStart_desc':\n                sorted.sort((a, b) => d(b.devStart) - d(a.devStart));\n                break;\n            case 'devEnd_inprogress_first':\n                sorted.sort((a, b) => {\n                    const ia = inProgress(a) ? 0 : 1;\n                    const ib = inProgress(b) ? 0 : 1;\n                    if (ia !== ib) return ia - ib;\n                    return d(a.devEnd) - d(b.devEnd);\n                });\n                break;\n            case 'test_inprogress_first':\n                sorted.sort((a, b) => {\n                    const ia = inProgress(a) ? 0 : 1;\n                    const ib = inProgress(b) ? 0 : 1;\n                    if (ia !== ib) return ia - ib;\n                    return d(a.dataTest) - d(b.dataTest);\n                });\n                break;\n            case 'alpha_asc':\n                sorted.sort((a, b) => a.nome.localeCompare(b.nome, 'it'));\n                break;\n            case 'alpha_desc':\n                sorted.sort((a, b) => b.nome.localeCompare(a.nome, 'it'));\n                break;\n        }\n        return sorted;\n    },\n\n    renderAll: function() {\n        this.renderTable();\n        this.renderGantt();\n        this.renderCalendar();\n    },\n\n    renderTable: function() {\n        const tbody    = document.getElementById('projectsTableBody');\n        const search   = (document.getElementById('searchInput')?.value || '').toLowerCase();\n        const filtForn = document.getElementById('tableFornitoreFilter')?.value || '';\n        const filtOwn  = document.getElementById('tableOwnerFilter')?.value || '';\n        const sortMode = document.getElementById('tableSortSelect')?.value || 'prod_inprogress_first';\n        const showHidden = document.getElementById('globalShowHidden')?.checked || false;\n\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n\n        let filtered = this.data.filter(p =>\n            (showHidden || !this.isHiddenForUI(p)) &&\n            p.nome.toLowerCase().includes(search) &&\n            (!filtForn || (p.fornitori && p.fornitori.includes(filtForn))) &&\n            (!filtOwn  || (p.owners    && p.owners.includes(filtOwn)))\n        );\n        filtered = this._sortGantt(filtered, sortMode);\n\n        tbody.innerHTML = filtered.map(p => {\n            const isPast = p.dataProd && new Date(p.dataProd) <= today;\n            const autoStale = this.isAutoStale(p);\n            const currentlyHidden = this.isHiddenForUI(p);\n\n            let rowCls = '';\n            if (currentlyHidden) {\n                rowCls = 'class=\"table-warning opacity-75\"';\n            } else if (isPast) {\n                rowCls = 'class=\"table-secondary opacity-75\"';\n            }\n\n            const fornBadge = (p.fornitori || []).map(f => this._badgeSpan('supplier', f, 'badge me-1 mb-1')).join('');\n            const ownBadge  = (p.owners    || []).map(o => this._badgeSpan('owner', o, 'badge me-1 mb-1')).join('');\n\n            const extraRows = [];\n            if (p.stimaGgu   != null) extraRows.push(`<span class=\"badge bg-info text-dark me-1\">‚è±Ô∏è ${p.stimaGgu} gg/u</span>`);\n            if (p.stimaCosto != null) extraRows.push(`<span class=\"badge bg-warning text-dark me-1\">üí∞ ‚Ç¨ ${p.stimaCosto.toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2})}</span>`);\n\n            const links = (p.jiraLinks && p.jiraLinks.length > 0) ? p.jiraLinks : (p.jira ? [p.jira] : []);\n            const jiraHtml = this.jiraLinksHtml(links);\n\n            let statusBadge = '';\n            if (p.hidden) {\n                statusBadge = '<span class=\"badge bg-dark ms-1\">üö´ Archiviato</span>';\n            } else if (autoStale) {\n                statusBadge = '<span class=\"badge bg-secondary ms-1\">üïê Auto-archiviato</span>';\n            } else if (isPast) {\n                statusBadge = '<span class=\"badge bg-success ms-1\">‚úÖ Rilasciato</span>';\n            }\n\n            return `\n            <tr ${rowCls}>\n                <td>\n                    <strong>${p.nome}</strong>\n                    ${statusBadge}\n                    ${jiraHtml ? `<div class=\"mt-1\">${jiraHtml}</div>` : ''}\n                    ${extraRows.length ? `<div class=\"mt-1\">${extraRows.join('')}</div>` : ''}\n                </td>\n                <td>\n                    <div class=\"d-flex flex-wrap\">${fornBadge}</div>\n                    ${ownBadge ? `<div class=\"mt-1 d-flex flex-wrap\">${ownBadge}</div>` : ''}\n                </td>\n                <td class=\"text-muted small\">${this.formatDate(p.dataStima)}</td>\n                <td class=\"text-muted small\">${this.formatDate(p.dataIA)}</td>\n                <td class=\"small\">${this.formatDate(p.devStart)} ‚ûî ${this.formatDate(p.devEnd)}</td>\n                <td class=\"text-warning small fw-bold\">${this.formatDate(p.dataTest)}</td>\n                <td class=\"text-success small fw-bold\">${this.formatDate(p.dataProd)}</td>\n                <td class=\"small text-muted\" style=\"max-width: 250px; white-space: pre-wrap;\">${p.note || ''}</td>\n                <td>\n                    <button class=\"btn btn-sm ${p.hidden ? 'btn-secondary' : 'btn-outline-secondary'} mb-1\" onclick=\"app.toggleHidden('${p.id}')\" title=\"${p.hidden ? 'Ripristina Progetto' : 'Archivia (Nascondi)'}\">${p.hidden ? 'üëÅÔ∏è' : 'üö´'}</button>\n                    <button class=\"btn btn-sm btn-outline-primary mb-1\" onclick=\"app.openModal('${p.id}')\" title=\"Modifica\">‚úèÔ∏è</button>\n                    <button class=\"btn btn-sm btn-outline-danger mb-1\" onclick=\"app.deleteProject('${p.id}')\" title=\"Elimina\">üóëÔ∏è</button>\n                </td>\n            </tr>`;\n        }).join('');\n    },\n\n    renderGantt: function() {\n        const container = document.getElementById('gantt-chart');\n        if (!container) return;\n\n        const filtForn = document.getElementById('ganttFornitoreFilter')?.value || '';\n        const filtOwn  = document.getElementById('ganttOwnerFilter')?.value || '';\n        const sortMode = document.getElementById('ganttSortSelect')?.value || 'prod_inprogress_first';\n        const showHidden = document.getElementById('globalShowHidden')?.checked || false;\n\n        let data = this.data.filter(p =>\n            (showHidden || !this.isHiddenForUI(p)) &&\n            (!filtForn || (p.fornitori && p.fornitori.includes(filtForn))) &&\n            (!filtOwn  || (p.owners    && p.owners.includes(filtOwn))) &&\n            (p.devStart || p.devEnd || p.dataTest || p.dataProd || p.dataIA || (p.customMilestones && p.customMilestones.length > 0))\n        );\n        data = this._sortGantt(data, sortMode);\n\n        if (data.length === 0) {\n            container.innerHTML = \"<p class='text-center p-3 text-muted'>Nessun progetto con date programmate trovato per i filtri selezionati.</p>\";\n            return;\n        }\n\n        let minDate = null, maxDate = null;\n        const updateRange = d => {\n            if (!d) return;\n            const dt = new Date(d);\n            if (!minDate || dt < minDate) minDate = dt;\n            if (!maxDate || dt > maxDate) maxDate = dt;\n        };\n        data.forEach(p => {\n            [p.dataIA, p.devStart, p.devEnd, p.dataTest, p.dataProd,\n             p.dataUAT, p.dataBS, p.dataScadenzaStima, p.dataConfigSistema].forEach(updateRange);\n            if(p.customMilestones) {\n                p.customMilestones.forEach(m => updateRange(m.date));\n            }\n        });\n\n        // Fallback nel caso in cui le date filtrate siano invalide\n        if (!minDate || !maxDate) {\n            minDate = new Date(); maxDate = new Date();\n        }\n\n        minDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1);\n        let maxMonth = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);\n        if (maxMonth <= minDate) maxMonth = new Date(minDate.getFullYear(), minDate.getMonth() + 2, 0);\n        maxDate = maxMonth;\n\n        const totalDays = Math.ceil((maxDate - minDate) / 86400000);\n        const pct = d => {\n            const days = (new Date(d) - minDate) / 86400000;\n            return Math.min(Math.max((days / totalDays) * 100, 0), 100);\n        };\n\n        let html = '<div class=\"gantt-custom\"><div class=\"gantt-header\"><div class=\"gantt-project-col\">Progetto</div><div class=\"gantt-timeline-col\"><div class=\"gantt-months\">';\n        let cur = new Date(minDate);\n        while (cur <= maxDate) {\n            const name = dayjs(cur).format('MMM YYYY');\n            const days = new Date(cur.getFullYear(), cur.getMonth() + 1, 0).getDate();\n            html += `<div class=\"gantt-month\" style=\"width:${((days/totalDays)*100).toFixed(2)}%\">${name}</div>`;\n            cur = new Date(cur.getFullYear(), cur.getMonth() + 1, 1);\n        }\n        html += '</div></div></div><div class=\"gantt-body\">';\n\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n\n        data.forEach(p => {\n            // Se manca la barra di sviluppo, la disegno invisibile per non far sballare l'UI\n            const startD = p.devStart ? p.devStart : (p.dataTest || p.dataProd || p.dataIA);\n            const endD   = p.devEnd   ? p.devEnd   : startD;\n            \n            const leftPct  = startD ? pct(startD) : 0;\n            const widthPct = startD && endD ? Math.max(pct(endD) - leftPct, 0.5) : 0;\n            const barOpacity = (p.devStart && p.devEnd) ? 1 : 0.2;\n\n            const badgesHtml = [\n                ...(p.fornitori || []).map(f => this._badgeSpan('supplier', f, 'gantt-supplier-badge mb-1')),\n                ...(p.owners    || []).map(o => this._badgeSpan('owner', o, 'gantt-supplier-badge mb-1'))\n            ].join('');\n\n            const isPast = p.dataProd && new Date(p.dataProd) <= today;\n            const autoStale = this.isAutoStale(p);\n            const currentlyHidden = this.isHiddenForUI(p);\n\n            let rowCls = isPast ? ' gantt-row--released' : '';\n            if (currentlyHidden) rowCls += ' opacity-50'; // Opacizza i progetti archiviati\n\n            let statusIcon = '';\n            if (p.hidden) statusIcon = '<span class=\"badge bg-dark ms-1\">üö´</span>';\n            else if (autoStale) statusIcon = '<span class=\"badge bg-secondary ms-1\" title=\"Auto-archiviato\">üïê</span>';\n\n            let allMilestones = [\n                { date: p.dataIA,            cls: 'ms-ia',         icon: 'ü§ñ', label: 'Consegna IA',           always: true  },\n                { date: p.devStart,          cls: 'ms-dev-start',  icon: '‚ñ∂Ô∏è',  label: 'Inizio Sviluppo',       always: true  },\n                { date: p.devEnd,            cls: 'ms-dev-end',    icon: '‚èπÔ∏è',  label: 'Fine Sviluppo',         always: true  },\n                { date: p.dataUAT,           cls: 'ms-uat',        icon: 'üë•', label: 'UAT',                   always: false },\n                { date: p.dataBS,            cls: 'ms-bs',         icon: 'üíº', label: 'Business Simulation',   always: false },\n                { date: p.dataTest,          cls: 'ms-test',       icon: 'üß™', label: 'Rilascio Test',         always: true  },\n                { date: p.dataProd,          cls: 'ms-prod',       icon: 'üöÄ', label: 'Rilascio Prod',         always: true  },\n                { date: p.dataScadenzaStima, cls: 'ms-scad-stima', icon: 'üì•', label: 'Scad. Stima Fornitore', always: false },\n                { date: p.dataConfigSistema, cls: 'ms-config-sis', icon: 'üîß', label: 'Config Sistema',        always: false }\n            ];\n\n            if (p.customMilestones) {\n                p.customMilestones.forEach(cm => {\n                    allMilestones.push({\n                        date: cm.date,\n                        cls: 'ms-custom',\n                        icon: '‚≠ê',\n                        label: cm.label,\n                        always: false\n                    });\n                });\n            }\n\n            allMilestones = allMilestones.filter(m => m.date && m.date.trim() !== '');\n\n            const dateGroups = {};\n            allMilestones.forEach(m => { (dateGroups[m.date] = dateGroups[m.date] || []).push(m); });\n            allMilestones.forEach(m => {\n                const g = dateGroups[m.date];\n                m.offsetPx = (g.indexOf(m) - (g.length - 1) / 2) * 20;\n            });\n\n            const milestonesHtml = allMilestones.map(m => {\n                const translateX = (-16 + m.offsetPx).toFixed(0);\n                const inlineColor = m.cls === 'ms-custom' ? 'color:#198754;' : '';\n                const inlineLineColor = m.cls === 'ms-custom' ? 'background:#198754;' : '';\n                return `<div class=\"gantt-milestone ${m.cls}\" style=\"left:${pct(m.date).toFixed(2)}%;transform:translateX(${translateX}px);\" title=\"${m.label}: ${dayjs(m.date).format('DD/MM/YYYY')}\">\n                    <span class=\"ms-date\" style=\"${inlineColor}\">${dayjs(m.date).format('DD/MM')}</span>\n                    <span class=\"ms-icon\">${m.icon}</span>\n                    <span class=\"ms-line\" style=\"${inlineLineColor}\"></span>\n                </div>`;\n            }).join('');\n\n            html += `\n                <div class=\"gantt-row${rowCls}\">\n                    <div class=\"gantt-project-col\"><div><strong>${p.nome} ${statusIcon}</strong><div class=\"gantt-supplier-list\">${badgesHtml}</div></div></div>\n                    <div class=\"gantt-timeline-col\" style=\"position:relative;\">\n                        <div class=\"gantt-bar\" style=\"left:${leftPct.toFixed(2)}%;width:${widthPct.toFixed(2)}%;opacity:${barOpacity};\" title=\"Sviluppo: ${dayjs(startD).format('DD/MM/YYYY')} - ${dayjs(endD).format('DD/MM/YYYY')}\">\n                            <span>‚öôÔ∏è Sviluppo</span>\n                        </div>\n                        ${milestonesHtml}\n                    </div>\n                </div>`;\n        });\n        html += '</div>';\n\n        const hasUAT       = data.some(p => p.dataUAT           && p.dataUAT.trim()           !== '');\n        const hasBS        = data.some(p => p.dataBS            && p.dataBS.trim()            !== '');\n        const hasScadStima = data.some(p => p.dataScadenzaStima && p.dataScadenzaStima.trim() !== '');\n        const hasConfigSis = data.some(p => p.dataConfigSistema && p.dataConfigSistema.trim() !== '');\n        const hasCustom    = data.some(p => p.customMilestones  && p.customMilestones.length  > 0);\n\n        html += `\n        <div class=\"gantt-legend\">\n            <div class=\"gantt-legend-item\"><span class=\"legend-bar\"></span> Fase di Sviluppo</div>\n            <div class=\"gantt-legend-item\"><span class=\"legend-ms\">ü§ñ</span> Consegna IA</div>\n            <div class=\"gantt-legend-item\"><span class=\"legend-ms\">‚ñ∂Ô∏è</span> Inizio Sviluppo</div>\n            <div class=\"gantt-legend-item\"><span class=\"legend-ms\">‚èπÔ∏è</span> Fine Sviluppo</div>\n            ${hasUAT       ? '<div class=\"gantt-legend-item\"><span class=\"legend-ms\">üë•</span> UAT</div>'                       : ''}\n            ${hasBS        ? '<div class=\"gantt-legend-item\"><span class=\"legend-ms\">üíº</span> Business Simulation</div>'        : ''}\n            <div class=\"gantt-legend-item\"><span class=\"legend-ms\">üß™</span> Rilascio Test</div>\n            <div class=\"gantt-legend-item\"><span class=\"legend-ms\">üöÄ</span> Rilascio Prod</div>\n            ${hasScadStima ? '<div class=\"gantt-legend-item\"><span class=\"legend-ms\">üì•</span> Scad. Stima Fornitore</div>'     : ''}\n            ${hasConfigSis ? '<div class=\"gantt-legend-item\"><span class=\"legend-ms\">üîß</span> Config Sistema</div>'            : ''}\n            ${hasCustom    ? '<div class=\"gantt-legend-item\"><span class=\"legend-ms\" style=\"color:#198754\">‚≠ê</span> Milestone Personalizzate</div>'            : ''}\n        </div>`;\n\n        html += '</div>';\n        container.innerHTML = html;\n    },\n\n    renderCalendar: function() {\n        const container = document.getElementById('calendarContainer');\n        if (!container) return;\n\n        const filtForn = document.getElementById('calendarFornitoreFilter')?.value || '';\n        const filtOwn  = document.getElementById('calendarOwnerFilter')?.value    || '';\n        const filtMile = document.getElementById('calendarMilestoneFilter')?.value || '';\n        const showHidden = document.getElementById('globalShowHidden')?.checked || false;\n\n        const activeMilestones = filtMile && filtMile !== 'custom'\n            ? this.MILESTONES.filter(m => m.key === filtMile)\n            : this.MILESTONES;\n\n        const events = [];\n        this.data\n            .filter(p =>\n                (showHidden || !this.isHiddenForUI(p)) &&\n                (!filtForn || (p.fornitori && p.fornitori.includes(filtForn))) &&\n                (!filtOwn  || (p.owners    && p.owners.includes(filtOwn)))\n            )\n            .forEach(p => {\n                const currentlyHidden = this.isHiddenForUI(p);\n                const autoStale = this.isAutoStale(p);\n                \n                // Milestones standard\n                if (filtMile !== 'custom') {\n                    activeMilestones.forEach(m => {\n                        const v = p[m.key];\n                        if (v && v.trim() !== '') {\n                            events.push({\n                                date:      dayjs(v),\n                                sortKey:   v,\n                                nome:      p.nome,\n                                fornitori: p.fornitori || [],\n                                owners:    p.owners    || [],\n                                label:     m.label,\n                                badge:     m.badge,\n                                hidden:    currentlyHidden,\n                                manual:    p.hidden,\n                                autoStale: autoStale\n                            });\n                        }\n                    });\n                }\n                \n                // Custom Milestones\n                if ((filtMile === '' || filtMile === 'custom') && p.customMilestones) {\n                    p.customMilestones.forEach(cm => {\n                        if (cm.date && cm.date.trim() !== '') {\n                            events.push({\n                                date:      dayjs(cm.date),\n                                sortKey:   cm.date,\n                                nome:      p.nome,\n                                fornitori: p.fornitori || [],\n                                owners:    p.owners    || [],\n                                label:     `‚≠ê ${cm.label}`,\n                                badge:     'bg-success', // colore verde\n                                hidden:    currentlyHidden,\n                                manual:    p.hidden,\n                                autoStale: autoStale\n                            });\n                        }\n                    });\n                }\n            });\n\n        if (events.length === 0) {\n            container.innerHTML = \"<div class='col-12'><p class='text-center text-muted p-3'>Nessun evento da visualizzare per i filtri selezionati.</p></div>\";\n            return;\n        }\n\n        const groups = {};\n        events.forEach(ev => {\n            const key = ev.date.format('YYYY-MM');\n            if (!groups[key]) groups[key] = { label: ev.date.format('MMMM YYYY'), events: [] };\n            groups[key].events.push(ev);\n        });\n\n        container.innerHTML = Object.keys(groups).sort().map(k => {\n            const g = groups[k];\n            const sorted = g.events.sort((a, b) => a.sortKey.localeCompare(b.sortKey));\n            return `\n                <div class=\"col-md-4 mb-4\">\n                    <div class=\"card cal-month-card shadow-sm h-100\">\n                        <div class=\"card-header bg-white fw-bold text-uppercase text-primary\">${g.label}</div>\n                        <div class=\"card-body\">\n                            ${sorted.map(ev => {\n                                const fb = ev.fornitori.map(f => this._badgeSpan('supplier', f, 'gantt-supplier-badge mb-1')).join('');\n                                const ob = ev.owners.map(o    => this._badgeSpan('owner', o, 'gantt-supplier-badge mb-1')).join('');\n                                const opacityCls = ev.hidden ? 'opacity-50' : '';\n                                \n                                let statusIcon = '';\n                                if (ev.manual) statusIcon = 'üö´';\n                                else if (ev.autoStale) statusIcon = '<span title=\"Auto-archiviato\">üïê</span>';\n                                \n                                return `\n                                <div class=\"cal-event-item d-flex align-items-start gap-2 mb-2 ${opacityCls}\">\n                                    <span class=\"cal-event-date\">${ev.date.format('DD/MM')}</span>\n                                    <div>\n                                        <span class=\"badge ${ev.badge} me-1\">${ev.label}</span>\n                                        <span class=\"small fw-semibold\">${ev.nome} ${statusIcon}</span>\n                                        ${fb || ob ? `<div class=\"cal-supplier-list mt-1\">${fb}${ob}</div>` : ''}\n                                    </div>\n                                </div>`;\n                            }).join('')}\n                        </div>\n                    </div>\n                </div>`;\n        }).join('');\n    },\n\n    formatDate: function(d) {\n        return d ? dayjs(d).format('DD/MM/YY') : 'N/A';\n    },\n\n    showAlert: function(msg, type = 'info', timeout = 0) {\n        const div = document.getElementById('alertArea');\n        if (!div) return;\n        div.innerHTML = `<div class=\"alert alert-${type} alert-dismissible fade show\" role=\"alert\">\n            ${msg}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button></div>`;\n        if (timeout) setTimeout(() => { div.innerHTML = ''; }, timeout);\n    }\n};\n\ndocument.addEventListener('DOMContentLoaded', () => app.init());