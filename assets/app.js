const app = {\n    data: [],\n    config: {\n        owner: '',\n        repo: '',\n        token: '',\n        path: 'data/projects.json'\n    },\n    sha: null,\n    editorModal: null,\n    settingsModal: null,\n    MAX_JIRA_LINKS: 10,\n    MAX_CUSTOM_MILESTONES: 5,\n\n    MILESTONES: [\n        { key: 'dataIA',            label: 'ü§ñ Consegna IA',           badge: 'bg-info text-dark' },\n        { key: 'devStart',          label: '‚ñ∂Ô∏è Inizio Sviluppo',        badge: 'bg-primary' },\n        { key: 'devEnd',            label: '‚èπÔ∏è Fine Sviluppo',          badge: 'bg-secondary' },\n        { key: 'dataUAT',           label: 'üë• UAT',                    badge: 'bg-info' },\n        { key: 'dataBS',            label: 'üíº Business Simulation',    badge: 'bg-dark' },\n        { key: 'dataTest',          label: 'üß™ Rilascio Test',          badge: 'bg-warning text-dark' },\n        { key: 'dataProd',          label: 'üöÄ Rilascio Prod',          badge: 'bg-success' },\n        { key: 'dataScadenzaStima', label: 'üì• Scad. Stima Fornitore', badge: 'bg-light text-dark border' },\n        { key: 'dataConfigSistema', label: 'üîß Config Sistema',         badge: 'bg-light text-dark border' }\n    ],\n\n    OWNER_COLORS: {\n        'simone': { bg: '#0d6efd', fg: '#ffffff' },\n        'flavia': { bg: '#6f42c1', fg: '#ffffff' },\n        'andrea': { bg: '#ffc107', fg: '#212529' },\n    },\n\n    init: function() {\n        try {\n            if (typeof dayjs === 'undefined') {\n                this.showAlert('Errore Critico: Libreria DayJS non trovata!', 'danger');\n                return;\n            }\n            if (typeof bootstrap === 'undefined') {\n                console.error('Bootstrap mancante');\n            }\n\n            const editorEl = document.getElementById('editorModal');\n            const settingsEl = document.getElementById('settingsModal');\n\n            if (editorEl) this.editorModal = new bootstrap.Modal(editorEl);\n            if (settingsEl) this.settingsModal = new bootstrap.Modal(settingsEl);\n\n            ['p_stimaGgu', 'p_rcFornitore'].forEach(id => {\n                const el = document.getElementById(id);\n                if (el) el.addEventListener('input', () => this.calcCosto());\n            });\n\n            const savedCfg = localStorage.getItem('pm_tracker_config');\n            if (savedCfg) {\n                this.config = JSON.parse(savedCfg);\n                this.loadData();\n            } else {\n                this.showSettings();\n            }\n        } catch (err) {\n            console.error('Init Error:', err);\n            this.showAlert('Errore inizializzazione app: ' + err.message, 'danger');\n        }\n    },\n\n    csvToArray: function(val) {\n        if (!val) return [];\n        try {\n            if (Array.isArray(val)) return val.map(s => (s || '').toString().trim()).filter(Boolean);\n            if (typeof val === 'string') return val.split(',').map(s => s.trim()).filter(Boolean);\n        } catch(e) { return []; }\n        return [];\n    },\n\n    normalizeProject: function(p) {\n        if (!p) return null;\n        try {\n            const owners    = this.csvToArray(p.owners || p.owner);\n            const fornitori = this.csvToArray(p.fornitori);\n            const customMilestones = Array.isArray(p.customMilestones) ? p.customMilestones : [];\n            const hidden = !!p.hidden;\n            return { ...p, owners, fornitori, customMilestones, hidden };\n        } catch (e) {\n            console.error('Error normalizing project:', p, e);\n            return p;\n        }\n    },\n\n    isAutoStale: function(p) {\n        if (!p || p.hidden || !p.dataProd) return false;\n        try {\n            const today = new Date();\n            today.setHours(0, 0, 0, 0);\n            const prodDate = new Date(p.dataProd);\n            if (isNaN(prodDate.getTime())) return false;\n            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());\n            return prodDate < oneMonthAgo;\n        } catch (e) {\n            return false;\n        }\n    },\n\n    isHiddenForUI: function(p) {\n        if (!p) return false;\n        return p.hidden || this.isAutoStale(p);\n    },\n\n    // --- UTILITY COLORI BADGE ---\n    _hashString: function(str) {\n        const s = (str || '').toString().trim().toLowerCase();\n        let h = 0;\n        for (let i = 0; i < s.length; i++) h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;\n        return Math.abs(h);\n    },\n    _autoColor: function(name, kind) {\n        const hue = this._hashString(`${kind}:${name}`) % 360;\n        return { bg: `hsl(${hue}, 65%, 45%)`, fg: '#ffffff' };\n    },\n    _badgeColor: function(kind, name) {\n        const key = (name || '').toString().trim().toLowerCase();\n        if (kind === 'owner' && this.OWNER_COLORS[key]) return this.OWNER_COLORS[key];\n        return this._autoColor(name, kind);\n    },\n    _badgeStyle: function(kind, name) {\n        const c = this._badgeColor(kind, name);\n        return `background: ${c.bg} !important; color: ${c.fg} !important; border: 1px solid rgba(0,0,0,0.12);`;\n    },\n    _badgeSpan: function(kind, name, className) {\n        const safeName = (name ?? '').toString();\n        return `<span class=\"${className}\" style=\"${this._badgeStyle(kind, safeName)}\">${safeName}</span>`;\n    },\n\n    // --- RENDER UTILS ---\n    renderCustomMilestoneFields: function(milestones) {\n        const container = document.getElementById('customMilestonesContainer');\n        if(!container) return;\n        container.innerHTML = '';\n        const items = (milestones && milestones.length > 0) ? milestones : [];\n        items.forEach((m, i) => this._appendCustomMilestoneField(m.label, m.date, i));\n        this._updateAddCustomMilestoneBtn();\n    },\n    _appendCustomMilestoneField: function(label, date, index) {\n        const container = document.getElementById('customMilestonesContainer');\n        if(!container) return;\n        const wrap = document.createElement('div');\n        wrap.className = 'd-flex align-items-center gap-2 mb-2 custom-milestone-row';\n        wrap.dataset.milestoneIndex = index;\n        wrap.innerHTML = `\n            <input type=\"text\" class=\"form-control form-control-sm custom-ms-label\" placeholder=\"Nome\" value=\"${label ? label.replace(/\"/g, '&quot;') : ''}\">\n            <input type=\"date\" class=\"form-control form-control-sm custom-ms-date\" value=\"${date || ''}\">\n            <button type=\"button\" class=\"btn btn-outline-danger btn-sm flex-shrink-0\" onclick=\"app.removeCustomMilestone(this)\">&times;</button>\n        `;\n        container.appendChild(wrap);\n    },\n    addCustomMilestone: function() {\n        const container = document.getElementById('customMilestonesContainer');\n        const count = container.querySelectorAll('.custom-milestone-row').length;\n        if (count >= this.MAX_CUSTOM_MILESTONES) return;\n        this._appendCustomMilestoneField('', '', count);\n        this._updateAddCustomMilestoneBtn();\n    },\n    removeCustomMilestone: function(btn) {\n        btn.closest('.custom-milestone-row').remove();\n        this._updateAddCustomMilestoneBtn();\n    },\n    _updateAddCustomMilestoneBtn: function() {\n        const container = document.getElementById('customMilestonesContainer');\n        const btn = document.querySelector('button[onclick=\"app.addCustomMilestone()\"]');\n        if (!btn) return;\n        const count = container ? container.querySelectorAll('.custom-milestone-row').length : 0;\n        btn.disabled = count >= this.MAX_CUSTOM_MILESTONES;\n        btn.textContent = count >= this.MAX_CUSTOM_MILESTONES ? `Limite (${this.MAX_CUSTOM_MILESTONES})` : '+ Aggiungi Milestone';\n    },\n    _getCustomMilestonesFromModal: function() {\n        const rows = Array.from(document.querySelectorAll('.custom-milestone-row'));\n        return rows.map(row => ({\n            label: row.querySelector('.custom-ms-label').value.trim(),\n            date: row.querySelector('.custom-ms-date').value\n        })).filter(m => m.label !== '' && m.date !== '');\n    },\n\n    jiraLabel: function(url) {\n        if (!url || !url.trim()) return '';\n        try {\n            const u = new URL(url.trim());\n            const parts = u.pathname.replace(/\\/$/, '').split('/');\n            return parts[parts.length - 1] || url;\n        } catch (e) { return url; }\n    },\n    jiraLinksHtml: function(jiraLinks) {\n        if (!jiraLinks || jiraLinks.length === 0) return '';\n        return jiraLinks.filter(u => u && u.trim()).map(u => \n            `<a href=\"${u}\" target=\"_blank\" class=\"badge bg-primary text-decoration-none me-1 mb-1\">${this.jiraLabel(u)} üîó</a>`\n        ).join('');\n    },\n    renderJiraFields: function(links) {\n        const container = document.getElementById('jiraLinksContainer');\n        if(!container) return;\n        container.innerHTML = '';\n        const items = (links && links.length > 0) ? links : [''];\n        items.forEach((url, i) => this._appendJiraField(url, i));\n        this._updateAddJiraBtn();\n    },\n    _appendJiraField: function(value, index) {\n        const container = document.getElementById('jiraLinksContainer');\n        const wrap = document.createElement('div');\n        wrap.className = 'd-flex align-items-center gap-2 mb-2';\n        wrap.dataset.jiraIndex = index;\n        wrap.innerHTML = `\n            <input type=\"url\" class=\"form-control jira-link-input\" placeholder=\"https://...\" value=\"${value ? value.replace(/\"/g, '&quot;') : ''}\">\n            <button type=\"button\" class=\"btn btn-outline-danger btn-sm flex-shrink-0\" onclick=\"app.removeJiraField(this)\">&times;</button>\n        `;\n        container.appendChild(wrap);\n    },\n    addJiraField: function() {\n        const container = document.getElementById('jiraLinksContainer');\n        const count = container.querySelectorAll('.jira-link-input').length;\n        if (count >= this.MAX_JIRA_LINKS) return;\n        this._appendJiraField('', count);\n        this._updateAddJiraBtn();\n    },\n    removeJiraField: function(btn) {\n        btn.closest('[data-jira-index]').remove();\n        this._updateAddJiraBtn();\n    },\n    _updateAddJiraBtn: function() {\n        const container = document.getElementById('jiraLinksContainer');\n        const btn = document.getElementById('addJiraBtn');\n        if (!btn) return;\n        const count = container.querySelectorAll('.jira-link-input').length;\n        btn.disabled = count >= this.MAX_JIRA_LINKS;\n        btn.textContent = count >= this.MAX_JIRA_LINKS ? `Limite (${this.MAX_JIRA_LINKS})` : '+ Aggiungi Link';\n    },\n    _getJiraLinksFromModal: function() {\n        return Array.from(document.querySelectorAll('.jira-link-input')).map(el => el.value.trim()).filter(v => v !== '');\n    },\n\n    calcCosto: function() {\n        const gguEl = document.getElementById('p_stimaGgu');\n        const rcEl = document.getElementById('p_rcFornitore');\n        const out = document.getElementById('p_stimaCosto');\n        if(!gguEl || !rcEl || !out) return;\n        const ggu = parseFloat(gguEl.value);\n        const rc  = parseFloat(rcEl.value);\n        if (!isNaN(ggu) && !isNaN(rc) && ggu >= 0 && rc >= 0) {\n            out.value = '‚Ç¨ ' + (ggu * rc).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n        } else {\n            out.value = '';\n        }\n    },\n\n    showSettings: function() {\n        if(!this.settingsModal) return;\n        document.getElementById('cfg_owner').value = this.config.owner;\n        document.getElementById('cfg_repo').value  = this.config.repo;\n        document.getElementById('cfg_token').value = this.config.token;\n        document.getElementById('cfg_path').value  = this.config.path;\n        this.settingsModal.show();\n    },\n    saveSettings: function() {\n        this.config = {\n            owner: document.getElementById('cfg_owner').value.trim(),\n            repo:  document.getElementById('cfg_repo').value.trim(),\n            token: document.getElementById('cfg_token').value.trim(),\n            path:  document.getElementById('cfg_path').value.trim() || 'data/projects.json'\n        };\n        localStorage.setItem('pm_tracker_config', JSON.stringify(this.config));\n        if(this.settingsModal) this.settingsModal.hide();\n        this.loadData();\n    },\n\n    loadData: async function() {\n        if (!this.config.token) return;\n        this.showAlert('Caricamento dati...', 'info');\n        try {\n            const url = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/contents/${this.config.path}?t=${new Date().getTime()}`;\n            const response = await fetch(url, {\n                headers: { 'Authorization': `token ${this.config.token}`, 'Accept': 'application/vnd.github.v3+json' }\n            });\n            if (!response.ok) throw new Error(`Errore GitHub: ${response.status}`);\n            const json = await response.json();\n            this.sha  = json.sha;\n            \n            let parsed = [];\n            try {\n                parsed = JSON.parse(decodeURIComponent(escape(atob(json.content))));\n            } catch(e) {\n                throw new Error('Errore parsing JSON: ' + e.message);\n            }\n            \n            this.data = parsed.map(p => this.normalizeProject(p)).filter(p => p !== null);\n            \n            this.populateFornitoreFilters();\n            this.populateOwnerFilters();\n            this.renderAll();\n            this.showAlert('Dati aggiornati!', 'success', 2000);\n        } catch (error) {\n            console.error(error);\n            this.showAlert(`Errore caricamento: ${error.message}`, 'danger');\n        }\n    },\n\n    populateFornitoreFilters: function() {\n        try {\n            const allSuppliers = [...new Set(this.data.flatMap(p => p.fornitori || []))].sort();\n            ['ganttFornitoreFilter', 'tableFornitoreFilter', 'calendarFornitoreFilter'].forEach(id => {\n                const sel = document.getElementById(id);\n                if (!sel) return;\n                const current = sel.value;\n                while (sel.options.length > 1) sel.remove(1);\n                allSuppliers.forEach(f => {\n                    const opt = document.createElement('option');\n                    opt.value = f; opt.textContent = f; sel.appendChild(opt);\n                });\n                if (current && allSuppliers.includes(current)) sel.value = current;\n            });\n        } catch(e) { console.error('Error populating filters', e); }\n    },\n\n    populateOwnerFilters: function() {\n        try {\n            const allOwners = [...new Set(this.data.flatMap(p => p.owners || []))].sort((a, b) => String(a).localeCompare(String(b), 'it'));\n            ['ganttOwnerFilter', 'tableOwnerFilter', 'calendarOwnerFilter'].forEach(id => {\n                const sel = document.getElementById(id);\n                if (!sel) return;\n                const current = sel.value;\n                while (sel.options.length > 1) sel.remove(1);\n                allOwners.forEach(o => {\n                    const opt = document.createElement('option');\n                    opt.value = o; opt.textContent = o; sel.appendChild(opt);\n                });\n                if (current && allOwners.includes(current)) sel.value = current;\n            });\n        } catch(e) { console.error('Error populating owner filters', e); }\n    },\n\n    saveProject: async function() {\n        try {\n            const dates = {\n                stima:    document.getElementById('p_stima').value || null,\n                ia:       document.getElementById('p_ia').value || null,\n                devStart: document.getElementById('p_devStart').value || null,\n                devEnd:   document.getElementById('p_devEnd').value || null,\n                test:     document.getElementById('p_test').value || null,\n                prod:     document.getElementById('p_prod').value || null,\n                uat:      document.getElementById('p_uat').value || null,\n                bs:       document.getElementById('p_bs').value || null\n            };\n\n            let errorMsg = '';\n            if (dates.stima && dates.devStart && dates.stima > dates.devStart) errorMsg = 'Stima > Dev Start';\n            else if (dates.devStart && dates.devEnd && dates.devStart > dates.devEnd) errorMsg = 'Dev Start > Dev End';\n            else if (dates.devEnd && dates.test && dates.devEnd > dates.test) errorMsg = 'Dev End > Test';\n            else if (dates.test && dates.prod && dates.test > dates.prod) errorMsg = 'Test > Prod';\n            \n            if (errorMsg) {\n                document.getElementById('dateValidationMsg').innerText = `ERRORE: ${errorMsg}`;\n                return;\n            }\n\n            const stimaGgu    = parseFloat(document.getElementById('p_stimaGgu').value);\n            const rcFornitore = parseFloat(document.getElementById('p_rcFornitore').value);\n            const id = document.getElementById('p_id').value;\n            const fornitori = document.getElementById('p_fornitori').value.split(',').map(s => s.trim()).filter(Boolean);\n            const owners    = document.getElementById('p_owners').value.split(',').map(s => s.trim()).filter(Boolean);\n\n            const newProj = {\n                id:                id || Date.now().toString(),\n                nome:              document.getElementById('p_nome').value,\n                fornitori:         fornitori,\n                owners:            owners,\n                dataStima:         dates.stima,\n                dataIA:            dates.ia,\n                devStart:          dates.devStart,\n                devEnd:            dates.devEnd,\n                dataTest:          dates.test,\n                dataProd:          dates.prod,\n                dataUAT:           dates.uat,\n                dataBS:            dates.bs,\n                jiraLinks:         this._getJiraLinksFromModal(),\n                customMilestones:  this._getCustomMilestonesFromModal(),\n                dataScadenzaStima: document.getElementById('p_dataScadenzaStima').value || null,\n                dataConfigSistema: document.getElementById('p_dataConfigSistema').value || null,\n                stimaGgu:          isNaN(stimaGgu)    ? null : stimaGgu,\n                rcFornitore:       isNaN(rcFornitore) ? null : rcFornitore,\n                stimaCosto:        (!isNaN(stimaGgu) && !isNaN(rcFornitore)) ? stimaGgu * rcFornitore : null,\n                note:              document.getElementById('p_note').value,\n                hidden:            false\n            };\n\n            if (id) {\n                const oldProj = this.data.find(p => p.id === id);\n                if (oldProj) {\n                    newProj.hidden = oldProj.hidden; \n                    // Reset hidden se l'utente modifica qualcosa? No, teniamo lo stato.\n                }\n                const idx = this.data.findIndex(p => p.id === id);\n                if(idx >= 0) this.data[idx] = newProj;\n                else this.data.push(newProj);\n            } else {\n                this.data.push(newProj);\n            }\n            await this.syncToGithub();\n            if(this.editorModal) this.editorModal.hide();\n        } catch(e) { this.showAlert('Errore salvataggio: ' + e.message, 'danger'); }\n    },\n\n    syncToGithub: async function() {\n        this.showAlert('Salvataggio su GitHub...', 'warning');\n        try {\n            const content = btoa(unescape(encodeURIComponent(JSON.stringify(this.data, null, 2))));\n            const url = `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/contents/${this.config.path}`;\n            const response = await fetch(url, {\n                method: 'PUT',\n                headers: { 'Authorization': `token ${this.config.token}`, 'Content-Type': 'application/json' },\n                body: JSON.stringify({ message: `Update data via PM Tracker webapp`, content, sha: this.sha })\n            });\n            if (!response.ok) throw new Error('Sync fallito');\n            this.sha = (await response.json()).content.sha;\n            this.showAlert('Salvato!', 'success', 2000);\n            await this.loadData();\n        } catch (e) {\n            console.error(e);\n            this.showAlert(`Errore sync: ${e.message}`, 'danger');\n        }\n    },\n\n    openModal: function(id = null) {\n        if(!this.editorModal) return;\n        document.getElementById('projectForm').reset();\n        document.getElementById('dateValidationMsg').innerText = '';\n        document.getElementById('p_stimaCosto').value = '';\n        if (id) {\n            const p = this.data.find(x => x.id === id);\n            if(p) {\n                document.getElementById('p_id').value                = p.id;\n                document.getElementById('p_nome').value              = p.nome || '';\n                document.getElementById('p_fornitori').value         = (p.fornitori || []).join(', ');\n                document.getElementById('p_owners').value            = (p.owners || []).join(', ');\n                document.getElementById('p_stima').value             = p.dataStima    || '';\n                document.getElementById('p_ia').value                = p.dataIA       || '';\n                document.getElementById('p_devStart').value          = p.devStart     || '';\n                document.getElementById('p_devEnd').value            = p.devEnd       || '';\n                document.getElementById('p_test').value              = p.dataTest     || '';\n                document.getElementById('p_prod').value              = p.dataProd     || '';\n                document.getElementById('p_uat').value               = p.dataUAT      || '';\n                document.getElementById('p_bs').value                = p.dataBS       || '';\n                document.getElementById('p_dataScadenzaStima').value = p.dataScadenzaStima || '';\n                document.getElementById('p_dataConfigSistema').value = p.dataConfigSistema || '';\n                document.getElementById('p_stimaGgu').value          = p.stimaGgu    != null ? p.stimaGgu    : '';\n                document.getElementById('p_rcFornitore').value       = p.rcFornitore != null ? p.rcFornitore : '';\n                document.getElementById('p_note').value              = p.note || '';\n                this.calcCosto();\n                \n                const links = p.jiraLinks && p.jiraLinks.length > 0 ? p.jiraLinks : (p.jira ? [p.jira] : []);\n                this.renderJiraFields(links);\n                this.renderCustomMilestoneFields(p.customMilestones || []);\n            }\n        } else {\n            document.getElementById('p_id').value = '';\n            this.renderJiraFields([]);\n            this.renderCustomMilestoneFields([]);\n        }\n        this.editorModal.show();\n    },\n\n    deleteProject: async function(id) {\n        if (confirm('Eliminare il progetto?')) {\n            this.data = this.data.filter(p => p.id !== id);\n            await this.syncToGithub();\n        }\n    },\n\n    toggleHidden: async function(id) {\n        const p = this.data.find(x => x.id === id);\n        if (p) {\n            // Toggle manuale\n            if (this.isAutoStale(p) && !p.hidden) {\n               // Se √® auto-stale, l'utente vuole vederlo, ma non possiamo cambiare il fatto che √® vecchio.\n               // Dobbiamo permettergli di \"sbiancarlo\" o forzarlo.\n               // Per ora lasciamo il comportamento standard: toggle flag manuale.\n            }\n            p.hidden = !p.hidden;\n            await this.syncToGithub();\n        }\n    },\n\n    _sortGantt: function(data, mode) {\n        try {\n            const today = new Date(); today.setHours(0,0,0,0);\n            const d = (val) => val ? new Date(val) : new Date(0);\n            const inProgress = (p) => { const prod = p.dataProd ? new Date(p.dataProd) : null; return !prod || prod > today; };\n            \n            return [...data].sort((a, b) => {\n                switch (mode) {\n                    case 'prod_inprogress_first':\n                        const ia = inProgress(a) ? 0 : 1; const ib = inProgress(b) ? 0 : 1;\n                        return (ia !== ib) ? ia - ib : d(a.dataProd) - d(b.dataProd);\n                    case 'prod_asc': return d(a.dataProd) - d(b.dataProd);\n                    case 'prod_desc': return d(b.dataProd) - d(a.dataProd);\n                    case 'devStart_inprogress_first':\n                         const isa = inProgress(a) ? 0 : 1; const isb = inProgress(b) ? 0 : 1;\n                         return (isa !== isb) ? isa - isb : d(a.devStart) - d(b.devStart);\n                    case 'devStart_asc': return d(a.devStart) - d(b.devStart);\n                    case 'devStart_desc': return d(b.devStart) - d(a.devStart);\n                    case 'devEnd_inprogress_first':\n                         const iea = inProgress(a) ? 0 : 1; const ieb = inProgress(b) ? 0 : 1;\n                         return (iea !== ieb) ? iea - ieb : d(a.devEnd) - d(b.devEnd);\n                    case 'test_inprogress_first':\n                         const ita = inProgress(a) ? 0 : 1; const itb = inProgress(b) ? 0 : 1;\n                         return (ita !== itb) ? ita - itb : d(a.dataTest) - d(b.dataTest);\n                    case 'alpha_asc': return (a.nome||'').localeCompare(b.nome||'', 'it');\n                    case 'alpha_desc': return (b.nome||'').localeCompare(a.nome||'', 'it');\n                    default: return 0;\n                }\n            });\n        } catch(e) { return data; }\n    },\n\n    renderAll: function() {\n        try {\n            this.renderTable();\n            this.renderGantt();\n            this.renderCalendar();\n        } catch(e) { console.error('Render error:', e); }\n    },\n\n    renderTable: function() {\n        const tbody = document.getElementById('projectsTableBody');\n        if (!tbody) return;\n        const search   = (document.getElementById('searchInput')?.value || '').toLowerCase();\n        const filtForn = document.getElementById('tableFornitoreFilter')?.value || '';\n        const filtOwn  = document.getElementById('tableOwnerFilter')?.value || '';\n        const sortMode = document.getElementById('tableSortSelect')?.value || 'prod_inprogress_first';\n        const showHidden = document.getElementById('globalShowHidden')?.checked || false;\n        const today = new Date(); today.setHours(0,0,0,0);\n\n        let filtered = this.data.filter(p => \n            p && (p.nome || '').toLowerCase().includes(search) &&\n            (showHidden || !this.isHiddenForUI(p)) &&\n            (!filtForn || (p.fornitori && p.fornitori.includes(filtForn))) &&\n            (!filtOwn || (p.owners && p.owners.includes(filtOwn)))\n        );\n        filtered = this._sortGantt(filtered, sortMode);\n\n        tbody.innerHTML = filtered.map(p => {\n            const isPast = p.dataProd && new Date(p.dataProd) <= today;\n            const autoStale = this.isAutoStale(p);\n            const currentlyHidden = this.isHiddenForUI(p);\n            let rowCls = '';\n            if (currentlyHidden) rowCls = 'class=\"table-warning opacity-75\"';\n            else if (isPast) rowCls = 'class=\"table-secondary opacity-75\"';\n\n            const fornBadge = (p.fornitori || []).map(f => this._badgeSpan('supplier', f, 'badge me-1 mb-1')).join('');\n            const ownBadge  = (p.owners || []).map(o => this._badgeSpan('owner', o, 'badge me-1 mb-1')).join('');\n            const extraRows = [];\n            if (p.stimaGgu != null) extraRows.push(`<span class=\"badge bg-info text-dark me-1\">‚è±Ô∏è ${p.stimaGgu} gg/u</span>`);\n            if (p.stimaCosto != null) extraRows.push(`<span class=\"badge bg-warning text-dark me-1\">üí∞ ‚Ç¨ ${p.stimaCosto.toLocaleString('it-IT', {minimumFractionDigits:2})}</span>`);\n            \n            let statusBadge = '';\n            if (p.hidden) statusBadge = '<span class=\"badge bg-dark ms-1\">üö´ Archiviato</span>';\n            else if (autoStale) statusBadge = '<span class=\"badge bg-secondary ms-1\">üïê Auto-archiviato</span>';\n            else if (isPast) statusBadge = '<span class=\"badge bg-success ms-1\">‚úÖ Rilasciato</span>';\n\n            return `<tr ${rowCls}>\n                <td><strong>${p.nome}</strong>${statusBadge}<div class=\"mt-1\">${this.jiraLinksHtml(p.jiraLinks || (p.jira ? [p.jira] : []))}</div><div class=\"mt-1\">${extraRows.join('')}</div></td>\n                <td><div class=\"d-flex flex-wrap\">${fornBadge}</div>${ownBadge ? `<div class=\"mt-1 d-flex flex-wrap\">${ownBadge}</div>` : ''}</td>\n                <td class=\"text-muted small\">${this.formatDate(p.dataStima)}</td>\n                <td class=\"text-muted small\">${this.formatDate(p.dataIA)}</td>\n                <td class=\"small\">${this.formatDate(p.devStart)} ‚ûî ${this.formatDate(p.devEnd)}</td>\n                <td class=\"text-warning small fw-bold\">${this.formatDate(p.dataTest)}</td>\n                <td class=\"text-success small fw-bold\">${this.formatDate(p.dataProd)}</td>\n                <td class=\"small text-muted\" style=\"max-width:250px;white-space:pre-wrap;\">${p.note||''}</td>\n                <td>\n                    <button class=\"btn btn-sm ${p.hidden?'btn-secondary':'btn-outline-secondary'} mb-1\" onclick=\"app.toggleHidden('${p.id}')\">${p.hidden?'üëÅÔ∏è':'üö´'}</button>\n                    <button class=\"btn btn-sm btn-outline-primary mb-1\" onclick=\"app.openModal('${p.id}')\">‚úèÔ∏è</button>\n                    <button class=\"btn btn-sm btn-outline-danger mb-1\" onclick=\"app.deleteProject('${p.id}')\">üóëÔ∏è</button>\n                </td>\n            </tr>`;\n        }).join('');\n    },\n\n    renderGantt: function() {\n        const container = document.getElementById('gantt-chart');\n        if (!container) return;\n        const filtForn = document.getElementById('ganttFornitoreFilter')?.value || '';\n        const filtOwn  = document.getElementById('ganttOwnerFilter')?.value || '';\n        const sortMode = document.getElementById('ganttSortSelect')?.value || 'prod_inprogress_first';\n        const showHidden = document.getElementById('globalShowHidden')?.checked || false;\n\n        let data = this.data.filter(p => \n            p && (showHidden || !this.isHiddenForUI(p)) &&\n            (!filtForn || (p.fornitori && p.fornitori.includes(filtForn))) &&\n            (!filtOwn || (p.owners && p.owners.includes(filtOwn))) &&\n            (p.devStart || p.devEnd || p.dataTest || p.dataProd || p.dataIA || (p.customMilestones && p.customMilestones.length > 0))\n        );\n        data = this._sortGantt(data, sortMode);\n\n        if (data.length === 0) {\n            container.innerHTML = \"<p class='text-center p-3 text-muted'>Nessun progetto gantt trovato.</p>\";\n            return;\n        }\n\n        let minDate = null, maxDate = null;\n        const updateRange = d => {\n            if(!d) return;\n            const dt = new Date(d);\n            if(!minDate || dt < minDate) minDate = dt;\n            if(!maxDate || dt > maxDate) maxDate = dt;\n        };\n        data.forEach(p => {\n            [p.dataIA,p.devStart,p.devEnd,p.dataTest,p.dataProd,p.dataUAT,p.dataBS,p.dataScadenzaStima,p.dataConfigSistema].forEach(updateRange);\n            (p.customMilestones||[]).forEach(m => updateRange(m.date));\n        });\n        if(!minDate || !maxDate) { minDate = new Date(); maxDate = new Date(); }\n\n        minDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1);\n        let maxMonth = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);\n        if (maxMonth <= minDate) maxMonth = new Date(minDate.getFullYear(), minDate.getMonth() + 2, 0);\n        maxDate = maxMonth;\n        const totalDays = Math.ceil((maxDate - minDate) / 86400000);\n        const pct = d => Math.min(Math.max(((new Date(d) - minDate) / 86400000 / totalDays) * 100, 0), 100);\n\n        let html = '<div class=\"gantt-custom\"><div class=\"gantt-header\"><div class=\"gantt-project-col\">Progetto</div><div class=\"gantt-timeline-col\"><div class=\"gantt-months\">';\n        let cur = new Date(minDate);\n        while (cur <= maxDate) {\n            const name = dayjs(cur).format('MMM YYYY');\n            const days = new Date(cur.getFullYear(), cur.getMonth() + 1, 0).getDate();\n            html += `<div class=\"gantt-month\" style=\"width:${((days/totalDays)*100).toFixed(2)}%\">${name}</div>`;\n            cur = new Date(cur.getFullYear(), cur.getMonth() + 1, 1);\n        }\n        html += '</div></div></div><div class=\"gantt-body\">';\n        const today = new Date(); today.setHours(0,0,0,0);\n\n        data.forEach(p => {\n            const startD = p.devStart ? p.devStart : (p.dataTest || p.dataProd || p.dataIA);\n            const endD   = p.devEnd ? p.devEnd : startD;\n            const leftPct = startD ? pct(startD) : 0;\n            const widthPct = startD && endD ? Math.max(pct(endD) - leftPct, 0.5) : 0;\n            const opacity = (p.devStart && p.devEnd) ? 1 : 0.2;\n            const isPast = p.dataProd && new Date(p.dataProd) <= today;\n            const autoStale = this.isAutoStale(p);\n            let rowCls = isPast ? ' gantt-row--released' : '';\n            if(this.isHiddenForUI(p)) rowCls += ' opacity-50';\n\n            let statusIcon = '';\n            if(p.hidden) statusIcon = '<span class=\"badge bg-dark ms-1\">üö´</span>';\n            else if(autoStale) statusIcon = '<span class=\"badge bg-secondary ms-1\">üïê</span>';\n\n            let milestones = [];\n            const addMs = (d, cls, icon, lbl) => { if(d) milestones.push({ date: d, cls, icon, label: lbl }); };\n            addMs(p.dataIA, 'ms-ia', 'ü§ñ', 'IA');\n            addMs(p.devStart, 'ms-dev-start', '‚ñ∂Ô∏è', 'Start');\n            addMs(p.devEnd, 'ms-dev-end', '‚èπÔ∏è', 'End');\n            addMs(p.dataUAT, 'ms-uat', 'üë•', 'UAT');\n            addMs(p.dataBS, 'ms-bs', 'üíº', 'BS');\n            addMs(p.dataTest, 'ms-test', 'üß™', 'Test');\n            addMs(p.dataProd, 'ms-prod', 'üöÄ', 'Prod');\n            (p.customMilestones||[]).forEach(m => addMs(m.date, 'ms-custom', '‚≠ê', m.label));\n            \n            // Group milestones to avoid overlap\n            const dateGroups = {};\n            milestones.forEach(m => { (dateGroups[m.date] = dateGroups[m.date] || []).push(m); });\n            milestones.forEach(m => { const g = dateGroups[m.date]; m.offsetPx = (g.indexOf(m) - (g.length - 1) / 2) * 20; });\n\n            const msHtml = milestones.map(m => {\n                const tx = (-16 + (m.offsetPx||0)).toFixed(0);\n                const style = m.cls === 'ms-custom' ? 'color:#198754;' : '';\n                return `<div class=\"gantt-milestone ${m.cls}\" style=\"left:${pct(m.date).toFixed(2)}%;transform:translateX(${tx}px)\" title=\"${m.label}: ${dayjs(m.date).format('DD/MM/YYYY')}\"><span class=\"ms-date\" style=\"${style}\">${dayjs(m.date).format('DD/MM')}</span><span class=\"ms-icon\">${m.icon}</span></div>`;\n            }).join('');\n\n            html += `<div class=\"gantt-row${rowCls}\">\n                <div class=\"gantt-project-col\"><div><strong>${p.nome} ${statusIcon}</strong></div></div>\n                <div class=\"gantt-timeline-col\" style=\"position:relative;\">\n                    <div class=\"gantt-bar\" style=\"left:${leftPct.toFixed(2)}%;width:${widthPct.toFixed(2)}%;opacity:${opacity}\"><span>‚öôÔ∏è</span></div>\n                    ${msHtml}\n                </div>\n            </div>`;\n        });\n        html += '</div></div>';\n        container.innerHTML = html;\n    },\n\n    renderCalendar: function() {\n        const container = document.getElementById('calendarContainer');\n        if (!container) return;\n        const filtForn = document.getElementById('calendarFornitoreFilter')?.value || '';\n        const filtOwn  = document.getElementById('calendarOwnerFilter')?.value || '';\n        const filtMile = document.getElementById('calendarMilestoneFilter')?.value || '';\n        const showHidden = document.getElementById('globalShowHidden')?.checked || false;\n\n        const events = [];\n        const msList = (filtMile && filtMile !== 'custom') ? this.MILESTONES.filter(m => m.key === filtMile) : this.MILESTONES;\n        \n        this.data.filter(p => \n            p && (showHidden || !this.isHiddenForUI(p)) &&\n            (!filtForn || (p.fornitori && p.fornitori.includes(filtForn))) &&\n            (!filtOwn || (p.owners && p.owners.includes(filtOwn)))\n        ).forEach(p => {\n            const hidden = this.isHiddenForUI(p);\n            const autoStale = this.isAutoStale(p);\n            if (filtMile !== 'custom') {\n                msList.forEach(m => {\n                    if(p[m.key]) events.push({ date: dayjs(p[m.key]), label: m.label, badge: m.badge, nome: p.nome, hidden, autoStale });\n                });\n            }\n            if (filtMile === '' || filtMile === 'custom') {\n                (p.customMilestones||[]).forEach(cm => {\n                     if(cm.date) events.push({ date: dayjs(cm.date), label: `‚≠ê ${cm.label}`, badge: 'bg-success', nome: p.nome, hidden, autoStale });\n                });\n            }\n        });\n\n        if (events.length === 0) { container.innerHTML = \"<p class='text-muted text-center col-12'>Nessun evento.</p>\"; return; }\n\n        const groups = {};\n        events.forEach(ev => {\n            const k = ev.date.format('YYYY-MM');\n            if(!groups[k]) groups[k] = { label: ev.date.format('MMMM YYYY'), items: [] };\n            groups[k].items.push(ev);\n        });\n\n        container.innerHTML = Object.keys(groups).sort().map(k => {\n            const g = groups[k];\n            return `<div class=\"col-md-4 mb-4\"><div class=\"card shadow-sm h-100\"><div class=\"card-header fw-bold text-primary\">${g.label}</div><div class=\"card-body\">` +\n            g.items.sort((a,b) => a.date.valueOf() - b.date.valueOf()).map(ev => `\n                <div class=\"d-flex align-items-start gap-2 mb-2 ${ev.hidden ? 'opacity-50' : ''}\">\n                    <span class=\"fw-bold\">${ev.date.format('DD/MM')}</span>\n                    <div><span class=\"badge ${ev.badge} me-1\">${ev.label}</span><span class=\"small\">${ev.nome} ${ev.autoStale ? 'üïê' : ''}</span></div>\n                </div>\n            `).join('') + '</div></div></div>';\n        }).join('');\n    },\n\n    formatDate: function(d) {\n        return d ? dayjs(d).format('DD/MM/YY') : 'N/A';\n    },\n\n    showAlert: function(msg, type = 'info', timeout = 0) {\n        const div = document.getElementById('alertArea');\n        if (!div) return;\n        div.innerHTML = `<div class=\"alert alert-${type} alert-dismissible fade show\">${msg}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button></div>`;\n        if (timeout) setTimeout(() => div.innerHTML = '', timeout);\n    }\n};\n\ndocument.addEventListener('DOMContentLoaded', () => app.init());